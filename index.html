<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>南北season与似缘若浠</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
    
    <!-- Firebase 初始化 -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC3ZQAKEDGS02vWh1alwTGa1H-zYxJKCIM",
            authDomain: "fangslove629.firebaseapp.com",
            projectId: "fangslove629",
            storageBucket: "fangslove629.firebasestorage.app",
            messagingSenderId: "203655156804",
            appId: "1:203655156804:web:7382793487b4534d36d811"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#F97316',
                        secondary: '#EC4899'
                    }
                }
            }
        }
    </script>

    <style type="text/tailwindcss">
        @layer utilities {
            .goal-card {
                @apply bg-white rounded-xl p-5 shadow-md hover:shadow-lg transition-all;
            }
            .btn-primary {
                @apply bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90;
            }
            .btn-secondary {
                @apply bg-secondary text-white px-4 py-2 rounded-lg hover:bg-secondary/90;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pt-20">
    <!-- 导航栏 -->
    <nav class="bg-white shadow-sm fixed top-0 left-0 right-0 z-10 p-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-primary flex items-center">
                <i class="fa fa-heart mr-2 text-secondary animate-pulse"></i>
                今天也很爱姐姐哦
            </h1>
            <div class="flex items-center gap-4">
                <div class="bg-gray-100 rounded-full px-4 py-1.5 flex items-center">
                    <i class="fa fa-star text-yellow-400 mr-1"></i>
                    <span id="total-points" class="font-bold">0</span>
                    <span class="ml-1">积分</span>
                </div>
                <button id="switch-to-rewards" class="btn-primary text-sm">
                    <i class="fa fa-gift mr-1"></i> 兑换奖励
                </button>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- 目标区域 -->
        <section id="goals-area">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">每日目标</h2>
                <button id="add-goal" class="btn-secondary">
                    <i class="fa fa-plus mr-1"></i> 添加目标
                </button>
            </div>
            <div id="goals-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 目标卡片将动态生成 -->
            </div>
        </section>

        <!-- 奖励区域（默认隐藏） -->
        <section id="rewards-area" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">奖励兑换</h2>
                <button id="back-to-goals" class="btn-primary">
                    <i class="fa fa-arrow-left mr-1"></i> 返回目标
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <h3 class="text-xl font-semibold mb-4">可用积分</h3>
                    <div class="flex items-center justify-center py-8">
                        <span id="points-display" class="text-5xl font-bold text-primary">0</span>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl p-6 shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">可兑换奖励</h3>
                        <button id="add-reward" class="btn-secondary text-sm">
                            <i class="fa fa-plus mr-1"></i> 添加奖励
                        </button>
                    </div>
                    <div id="rewards-list" class="space-y-4">
                        <!-- 奖励将动态生成 -->
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 添加目标弹窗 -->
    <div id="goal-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 class="text-xl font-bold mb-4">添加新目标</h3>
            <form id="goal-form">
                <div class="mb-4">
                    <label class="block mb-2">目标名称</label>
                    <input type="text" id="goal-name" class="w-full p-2 border rounded-lg" required>
                </div>
                <div class="mb-4">
                    <label class="block mb-2">奖励积分</label>
                    <input type="number" id="goal-points" class="w-full p-2 border rounded-lg" min="1" value="10" required>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-goal" class="px-4 py-2 border rounded-lg">取消</button>
                    <button type="submit" class="btn-primary">添加</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 数据存储
        const state = {
            goals: [],
            points: 0
        };

        // DOM元素
        const el = {
            goalsList: document.getElementById('goals-list'),
            totalPoints: document.getElementById('total-points'),
            goalsArea: document.getElementById('goals-area'),
            rewardsArea: document.getElementById('rewards-area'),
            switchToRewards: document.getElementById('switch-to-rewards'),
            backToGoals: document.getElementById('back-to-goals'),
            addGoal: document.getElementById('add-goal'),
            goalModal: document.getElementById('goal-modal'),
            cancelGoal: document.getElementById('cancel-goal'),
            goalForm: document.getElementById('goal-form')
        };

        // 初始化
        async function init() {
            try {
                // 从Firebase加载数据
                const doc = await db.collection('appData').doc('coupleGoals').get();
                if (doc.exists) {
                    const data = doc.data();
                    state.goals = data.goals || [];
                    state.points = data.totalPoints || 0;
                }
            } catch (e) {
                console.log('加载数据失败，使用本地存储');
                loadLocal();
            }
            renderGoals();
            updatePoints();
            bindEvents();
        }

        // 渲染目标列表
        function renderGoals() {
            el.goalsList.innerHTML = state.goals.length === 0 
                ? '<div class="col-span-full p-8 text-center bg-white rounded-xl">暂无目标</div>'
                : '';

            state.goals.forEach(goal => {
                const card = document.createElement('div');
                card.className = 'goal-card';
                card.innerHTML = `
                    <h3 class="font-bold text-lg">${goal.name}</h3>
                    <p class="text-gray-500 mt-2">+${goal.points}积分</p>
                    <button data-id="${goal.id}" class="checkin-btn w-full mt-4 py-2 bg-primary text-white rounded-lg">
                        完成签到
                    </button>
                `;
                el.goalsList.appendChild(card);
                card.querySelector('.checkin-btn').addEventListener('click', () => checkin(goal.id));
            });
        }

        // 签到功能
        function checkin(goalId) {
            const goal = state.goals.find(g => g.id === goalId);
            if (goal) {
                state.points += goal.points;
                saveData();
                updatePoints();
                alert(`签到成功，获得${goal.points}积分！`);
            }
        }

        // 保存数据
        async function saveData() {
            try {
                await db.collection('appData').doc('coupleGoals').set({
                    goals: state.goals,
                    totalPoints: state.points
                });
                saveLocal(); // 同时保存到本地
            } catch (e) {
                console.log('保存失败，使用本地存储');
                saveLocal();
            }
        }

        // 本地存储备份
        function saveLocal() {
            localStorage.setItem('goalsBackup', JSON.stringify(state.goals));
            localStorage.setItem('pointsBackup', state.points);
        }

        function loadLocal() {
            state.goals = JSON.parse(localStorage.getItem('goalsBackup') || '[]');
            state.points = parseInt(localStorage.getItem('pointsBackup') || '0');
        }

        // 更新积分显示
        function updatePoints() {
            el.totalPoints.textContent = state.points;
            document.getElementById('points-display').textContent = state.points;
        }

        // 添加目标
        function addNewGoal(name, points) {
            state.goals.push({
                id: Date.now().toString(),
                name,
                points: parseInt(points)
            });
            saveData();
            renderGoals();
        }

        // 绑定事件
        function bindEvents() {
            // 切换页面
            el.switchToRewards.addEventListener('click', () => {
                el.goalsArea.classList.add('hidden');
                el.rewardsArea.classList.remove('hidden');
            });
            el.backToGoals.addEventListener('click', () => {
                el.rewardsArea.classList.add('hidden');
                el.goalsArea.classList.remove('hidden');
            });

            // 目标弹窗
            el.addGoal.addEventListener('click', () => el.goalModal.classList.remove('hidden'));
            el.cancelGoal.addEventListener('click', () => el.goalModal.classList.add('hidden'));
            el.goalForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addNewGoal(
                    document.getElementById('goal-name').value,
                    document.getElementById('goal-points').value
                );
                el.goalModal.classList.add('hidden');
                el.goalForm.reset();
            });
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
